{% extends "shared/base.html" %}
{% block title %}
<title>{% if chip_structure %}Edit{% else %}Create{% endif %} Chip Structure</title>
{% endblock %}

{% block page_heading %}
{% if chip_structure %}Edit{% else %}Create{% endif %} Chip Structure
{% endblock %}

{% block content %}

{% if errors %}
<div class="alert alert-danger">
    <ul class="mb-0">
        {% for error in errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<form method="POST" id="chipStructureForm">
    <!-- Name Field -->
    <div class="form-floating mb-3">
        <input type="text" class="form-control" id="name" name="name" placeholder="Name"
            value="{{ form.name or chip_structure.name }}" required />
        <label>Name</label>
    </div>

    <input type="hidden" name="team_id" value="{{ team.id }}">

    <!-- Chip Rows -->
    <div class="mb-2">
        <label class="form-label text-muted small text-uppercase fw-bold">Chips</label>
    </div>
    <div id="chipRows">
        {% set chips_to_show = [] %}
        {% if form.chips %}
        {% set chips_to_show = form.chips %}
        {% elif chip_structure.chips %}
        {% set chips_to_show = chip_structure.chips %}
        {% else %}
        {# Initial empty state: show one row #}
        {% set chips_to_show = [{'color': '#FF0000', 'value': ''}] %}
        {% endif %}

        {% for chip in chips_to_show %}
        <div class="chip-row d-flex align-items-start gap-2 mb-2">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-3">
                    <div>
                        <input type="color" class="form-control form-control-color" name="color"
                            value="{{ chip.color }}" list="presetColors" />
                    </div>
                    <div class="flex-grow-1">
                        <input type="number" step="0.01" class="form-control" name="value" placeholder="Chip value"
                            value="{{ chip.value }}" required />
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-outline-danger btn-sm remove-chip align-self-center"
                title="Remove chip">
                ✕
            </button>
        </div>
        {% endfor %}
    </div>

    <datalist id="presetColors">
        <option value="#FFFFFF">White (1)</option>
        <option value="#FF0000">Red (5)</option>
        <option value="#0000FF">Blue (10)</option>
        <option value="#008000">Green (25)</option>
        <option value="#000000">Black (100)</option>
        <option value="#800080">Purple (500)</option>
        <option value="#FFA500">Orange (1000)</option>
        <option value="#A0522D">Brown (5000)</option>
    </datalist>

    <!-- Add Chip Button -->
    <div class="mb-3 text-center">
        <button type="button" id="addChip" class="btn btn-secondary btn-sm">
            <i class="bi bi-plus-lg"></i> Add Chip
        </button>
    </div>

    <!-- Submit & Back Buttons -->
    <div class="d-flex justify-content-between mt-4">
        <a href="/team/{{ team.id }}/chip_structures" class="btn btn-outline-secondary"><i
                class="bi bi-x-circle me-1"></i> Cancel</a>
        <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle-fill me-1"></i> Save
            Structure</button>
    </div>
</form>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const chipRows = document.getElementById("chipRows");
        const addChipBtn = document.getElementById("addChip");

        const chipTemplate = `
      <div class="chip-row d-flex align-items-start gap-2 mb-2">
        <div class="flex-grow-1">
          <div class="d-flex align-items-center gap-3">
            <div>
              <input type="color" class="form-control form-control-color" name="color" value="#FF0000" list="presetColors" />
            </div>
            <div class="flex-grow-1">
              <input type="number" step="0.01" class="form-control" name="value" placeholder="Chip value" required />
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-outline-danger btn-sm remove-chip align-self-center">✕</button>
      </div>
    `;

        addChipBtn.addEventListener("click", () => {
            const wrapper = document.createElement("div");
            wrapper.innerHTML = chipTemplate.trim();
            chipRows.appendChild(wrapper.firstElementChild);
        });

        chipRows.addEventListener("click", (e) => {
            if (e.target.classList.contains("remove-chip") || e.target.parentElement.classList.contains("remove-chip")) {
                const row = e.target.closest(".chip-row");
                const rows = document.querySelectorAll(".chip-row");
                if (rows.length > 1) row.remove();
            }
        });
    });
</script>

<style>
    .chip-row {
        margin-bottom: 0.4rem !important;
    }

    .remove-chip {
        height: 38px;
        width: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}