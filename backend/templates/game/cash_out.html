{% extends "shared/base.html" %} {% block title %}
<title>Cash Out</title>
{% endblock %} {% block page_heading %}
{% if target_player and target_player.id != user.id %}
Cash Out for {{ target_player.nick }}
{% else %}
Cash Out
{% endif %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-end mb-3">
  <a href="/game/{{ game_id }}/cash_out_by_amount{% if target_player and target_player.id != user.id %}?player_id={{ target_player.id }}{% endif %}"
    class="btn btn-outline-secondary">
    <i class="bi bi-box-arrow-right me-1"></i> Cash Out by Total Amount
  </a>
</div>

<form method="POST"
  action="/game/{{ game_id }}/cash_out{% if target_player and target_player.id != user.id %}?player_id={{ target_player.id }}{% endif %}"
  id="cashOutForm">
  <div class="row mb-3">
    <table class="table align-middle">
      <thead>
        <tr>
          <th class="text-center" style="width: 60px">Color</th>
          <th class="text-center" style="width: 100px">Value</th>
          <th class="text-center">Count</th>
          <th class="text-center" style="width: 100px">Total</th>
        </tr>
      </thead>
      <tbody>
        {% for chip in chip_structure %}
        <tr class="chip-row">
          <td class="text-center">
            <button type="button" class="btn btn-sm"
              style="background-color: {{ chip.color }}; width: 30px; height: 30px; filter: none;" disabled></button>
          </td>
          <td class="text-center chip-value" data-value="{{ chip.value }}">
            {{ "%.2f"|format(chip.value) }}
          </td>
          <td class="text-center">
            <input type="number" min="0" step="1" value="0" class="form-control chip-count" name="chip_{{ chip.id }}" />
          </td>
          <td class="text-center chip-total chip-total-static" style="text-align: right">
            0.00
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- The floating total display below the table -->
    <div class="d-flex justify-content-end mb-3">
      <span class="text-end fw-bold fs-4 me-3">Total:</span>
      <span id="totalValue" class="fw-bold fs-4">0.00</span>
    </div>
    <input type="hidden" name="totalValue" id="totalValueInput" value="0.00" />
  </div>


  <div class="d-flex justify-content-between align-items-center mt-4">
    <a href="/game/{{ game_id }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i> Back</a>
    <button type="submit" class="btn btn-primary"><i class="bi bi-box-arrow-right me-1"></i> Request Cash Out</button>
  </div>
</form>

{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("cashOutForm");
    const totalValueEl = document.getElementById("totalValue");
    const totalValueInput = document.getElementById("totalValueInput");

    form.addEventListener("input", (e) => {
      if (!e.target.classList.contains("chip-count")) return;

      let total = 0;
      document.querySelectorAll(".chip-row").forEach((row) => {
        const value = parseFloat(
          row.querySelector(".chip-value").dataset.value
        );
        const count = parseInt(row.querySelector(".chip-count").value) || 0;
        const subtotal = value * count;
        total += subtotal;

        row.querySelector(".chip-total").textContent = subtotal.toFixed(2);
      });

      totalValueEl.textContent = `${total.toFixed(2)}`;
      totalValueInput.value = total.toFixed(2); // ðŸ‘ˆ update hidden field
    });
  });
</script>

{% endblock %}