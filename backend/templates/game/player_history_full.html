{% extends "shared/base.html" %}

{% block title %}
<title>History: {{ player.nick }}</title>
{% endblock %}

{% block page_heading %}History: {{ player.nick }}{% endblock %}

{% block content %}

<div>
    <!-- Summary Header -->
    <div class="d-flex justify-content-between mb-3 px-2">
        <div class="text-center" style="flex: 1;">
            <small class="text-uppercase text-muted d-block" style="font-size: 0.7rem;">Money In</small>
            <span class="fs-5 fw-medium text-dark">{{ total_money_in }}</span>
        </div>
        {% if total_money_out > 0 %}
        <div class="text-center" style="flex: 1;">
            <small class="text-uppercase text-muted d-block" style="font-size: 0.7rem;">Balance</small>
            <span class="fs-5 fw-medium text-success">{{ total_money_out - total_money_in }}</span>
        </div>
        {% endif %}
    </div>

    <!-- History List -->
    <ul class="list-group list-group-flush" id="historyList">
        {% for event in events %}
        {% include "game/partials/history_row.html" %}
        {% endfor %}
    </ul>

    {% if can_edit %}
    <!-- Add New Event Section -->
    <div class="mt-4">
        <!-- Main Toolbar -->
        <div id="mainToolbar" class="d-flex gap-2 justify-content-between">
            <div>
                {% if request.query_params.return_url %}
                <a href="{{ request.query_params.return_url }}" class="btn btn-outline-secondary w-100">Back</a>
                {% else %}
                <a href="/game/{{ game.id }}" class="btn btn-outline-secondary w-100">Back</a>
                {% endif %}
            </div>
            <div>
                <button type="button" class="btn btn-primary w-100" onclick="showSection('cashoutSection')">
                    Cash-out
                </button>
            </div>
            <div>
                <button type="button" class="btn btn-primary w-100" onclick="showSection('addonSection')">
                    Add-on
                </button>
            </div>
        </div>

        <!-- Add-on Section (Hidden) -->
        <div id="addonSection" class="d-none mt-2">

            <div class="d-flex align-items-center justify-content-between gap-2 mb-3">
                <button type="button" class="btn btn-link text-decoration-none p-0 me-2"
                    onclick="showSection('mainToolbar')">
                    <i class="bi bi-arrow-left fs-4 text-dark"></i>
                </button>
                <!-- Manual Add Section -->
                <form hx-post="/game/{{ game.id }}/add_on?player_id={{ player.id }}" hx-target="#historyList"
                    hx-swap="none" class="d-flex gap-2 flex-grow-1" style="min-width: 0;">
                    <input type="number" class="form-control" name="add_on" step="0.01" required placeholder="Amount"
                        style="min-width: 50px;">
                    <button type="submit" class="btn btn-primary" style="min-width: 100px;">
                        Add
                    </button>
                </form>

                <span class="text-muted fw-bold me-4 ms-4">OR</span>
                <!-- Quick Add Button -->

                <form hx-post="/game/{{ game.id }}/add_on?player_id={{ player.id }}" hx-target="#historyList"
                    hx-swap="none" class="flex-grow-1">
                    <input type="hidden" name="add_on" value="{{ game.default_buy_in }}">
                    <button type="submit" class="btn btn-warning w-100 py-2">
                        +{{ game.default_buy_in }}
                    </button>
                </form>

            </div>
        </div>

        <!-- Cash-out Section (Hidden) -->
        <div id="cashoutSection" class="d-none mt-2">
            <div class="d-flex align-items-center justify-content-between gap-2 mb-3">
                <button type="button" class="btn btn-link text-decoration-none p-0 me-2"
                    onclick="showSection('mainToolbar')">
                    <i class="bi bi-arrow-left fs-4 text-dark"></i>
                </button>

                <form hx-post="/game/{{ game.id }}/cash_out_by_amount?player_id={{ player.id }}"
                    hx-target="#historyList" hx-swap="none" class="d-flex gap-2 flex-grow-1">
                    <input type="number" class="form-control" name="amount" step="0.01" required placeholder="Amount"
                        style="min-width: 50px;">
                    <button type="submit" class="btn btn-primary" style="min-width: 100px;">
                        Cash Out
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% else %}
    <div class="mt-4">
        {% if request.query_params.return_url %}
        <a href="{{ request.query_params.return_url }}" class="btn btn-outline-secondary">Back</a>
        {% else %}
        <a href="/game/{{ game.id }}" class="btn btn-outline-secondary">Back</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    // Simple reload on success for now to refresh the list cleanly
    document.body.addEventListener('htmx:afterRequest', function (evt) {
        if (evt.detail.successful) {
            // If it was an add or edit, we might want to reload to verify state/sorting
            if (evt.detail.elt.tagName === 'FORM') {
                setTimeout(() => window.location.reload(), 100);
            }
        }
    });

    function showSection(sectionId) {
        // Hide all sections
        document.getElementById('mainToolbar').classList.add('d-none');
        document.getElementById('addonSection').classList.add('d-none');
        document.getElementById('cashoutSection').classList.add('d-none');

        // Show target section and ensure flex is restored for toolbar if needed
        const target = document.getElementById(sectionId);
        target.classList.remove('d-none');
        if (sectionId === 'mainToolbar') {
            target.classList.add('d-flex');
        }
    }

    // Handle Delete Modal
    document.addEventListener('DOMContentLoaded', function () {
        const deleteModal = document.getElementById('deleteEventModal');
        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;
                const deleteUrl = button.getAttribute('data-delete-url');
                const targetId = button.getAttribute('data-target-id');
                const confirmBtn = deleteModal.querySelector('#confirmDeleteBtn');

                confirmBtn.onclick = function () {
                    // Use fetch for reliable execution independent of HTMX state
                    fetch(deleteUrl, { method: 'DELETE' })
                        .then(response => {
                            if (response.ok) {
                                // Reload page to ensure UI state is perfectly synced with backend
                                window.location.reload();
                            } else {
                                alert('Failed to delete the event.');
                            }
                        })
                        .catch(error => {
                            alert('An error occurred.');
                        });
                };
            });
        }
    });
</script>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this event?</p>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn"
                    data-bs-dismiss="modal">Delete</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}